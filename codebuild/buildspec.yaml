version: 0.2

phases:
  install:
    commands:
      - apt-get update
      - apt-get install -y git unzip jq openssh-client
  pre_build:
    commands:
      - |
        case "$REPO_URL" in
          https://*)
            git config --global credential.helper '!f() { echo "username=Barazii"; echo "password=$GITHUB_TOKEN"; }; f'
            ;;
          *)
            mkdir -p ~/.ssh
            echo "$SSH_KEY" > ~/.ssh/id_rsa
            chmod 600 ~/.ssh/id_rsa
            ssh-keyscan github.com >> ~/.ssh/known_hosts
            ;;
        esac
      - git config --global user.email $GITHUB_EMAIL
      - git config --global user.name $GITHUB_USER
  build:
    commands:
      # Cloning target repository from github
      - git clone $REPO_URL repo
      - cd repo
      # Downloading modified files from S3
      - aws s3 cp $S3_PATH changes.zip
      - unzip -o changes.zip
      - rm changes.zip
      # Apply deletions from any manifest(s) if present (POSIX sh-compatible)
      - |
        for MANIFEST_FILE in .gits-manifest-*.json; do
          [ -e "$MANIFEST_FILE" ] || continue
          echo "Found manifest: $MANIFEST_FILE"
          jq -r '.deleted[]? // empty' "$MANIFEST_FILE" 2>/dev/null | while IFS= read -r path; do
            [ -z "$path" ] && continue
            git rm -q --ignore-unmatch -- "$path" || true
          done
          rm -f "$MANIFEST_FILE"
        done
      # git operations
      - git add .
      - 'MSG="${COMMIT_MESSAGE:-Applied changes using gits}"'
      - git commit -m "$MSG" || echo "No changes to commit"
      - git push origin main