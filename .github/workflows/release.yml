name: Release (Ubuntu)

on:
  push:
    tags:
      - 'v*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update -y
          sudo apt-get install -y build-essential cmake pkg-config libcurl4-openssl-dev libssl-dev libzip-dev nlohmann-json3-dev

      - name: Build (Release)
        working-directory: backend
        run: |
          rm -rf build
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
          cmake --build build --config Release -- -j$(nproc)

      - name: Build .deb package (CPack)
        working-directory: backend/build
        run: |
          cpack -G DEB
          ls -1 *.deb

      - name: Smoke test
        run: |
          ./backend/build/gits --version || true

      - name: Strip binary
        run: |
          strip ./backend/build/gits || true

      - name: Package tarball
        run: |
          VERSION=${GITHUB_REF##*/}
          ART_DIR=dist
          mkdir -p "$ART_DIR"
          TAR_NAME="gits-${VERSION}-linux-x86_64.tar.gz"
          cp ./README.md "$ART_DIR"/README.md || true
          cp ./LICENSE "$ART_DIR"/LICENSE || true
          mkdir -p "$ART_DIR"/bin
          cp ./backend/build/gits "$ART_DIR"/bin/gits
          tar -C "$ART_DIR" -czf "$TAR_NAME" .
          sha256sum "$TAR_NAME" > "gits-${VERSION}-SHA256SUMS.txt"
          # Copy deb and generate checksum
          DEB_FILE=$(ls backend/build/*.deb | head -n1 || true)
          if [ -n "$DEB_FILE" ]; then
            cp "$DEB_FILE" "gits-${VERSION}-linux-amd64.deb"
            sha256sum "gits-${VERSION}-linux-amd64.deb" >> "gits-${VERSION}-SHA256SUMS.txt"
          fi
          echo "Created $TAR_NAME and checksums"

      - name: Upload artifacts (CI)
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-artifacts
          path: |
            gits-*-linux-x86_64.tar.gz
            gits-*-SHA256SUMS.txt
            gits-*-linux-amd64.deb

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            gits-${{ github.ref_name }}-linux-x86_64.tar.gz
            gits-${{ github.ref_name }}-SHA256SUMS.txt
            gits-${{ github.ref_name }}-linux-amd64.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}