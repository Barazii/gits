AWSTemplateFormatVersion: '2010-09-09'
Description: IAM roles and policies for gits system (Lambdas, CodeBuild, EventBridge target role) - modular stack.

Parameters:
  ProjectName:
    Type: String
    Default: gits
  DynamoTableName:
    Type: String
    Description: Name of DynamoDB table used by lambdas.
  ArtifactBucketName:
    Type: String
    Description: S3 bucket for uploaded change archives.
  CodeBuildLogGroupArn:
    Type: String
    Default: ''
    Description: Optional existing CloudWatch Logs group ARN for CodeBuild (leave blank to allow creation permissions anyway).

Resources:
  ScheduleLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-schedule-lambda-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: ScheduleLambdaAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: DynamoWrite
                Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                Resource: !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DynamoTableName}'
              - Sid: EventBridgeCreateRules
                Effect: Allow
                Action:
                  - events:PutRule
                  - events:PutTargets
                  - events:DescribeRule
                Resource: !Sub 'arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/*'
              - Sid: S3PutObject
                Effect: Allow
                Action:
                  - s3:PutObject
                Resource: !Sub 'arn:aws:s3:::${ArtifactBucketName}/*'
              - Sid: SecretsManagerCreate
                Effect: Allow
                Action:
                  - secretsmanager:CreateSecret
                  - secretsmanager:DescribeSecret
                  - secretsmanager:GetSecretValue
                  - secretsmanager:UpdateSecret
                Resource: !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:*'
              - Sid: PassRoleToEventBridge
                Effect: Allow
                Action: iam:PassRole
                Resource: !GetAtt EventBridgeTargetRole.Arn
              - Sid: ECRAccess
                Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                  - ecr:BatchCheckLayerAvailability
                  - ecr:GetDownloadUrlForLayer
                  - ecr:BatchGetImage
                Resource: '*'
              - Sid: EC2NetworkInterface
                Effect: Allow
                Action:
                  - ec2:CreateNetworkInterface
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DeleteNetworkInterface
                Resource: '*'
      Tags:
        - Key: Project
          Value: gits
  DeleteLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-delete-lambda-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DeleteLambdaAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: DynamoReadDelete
                Effect: Allow
                Action:
                  - dynamodb:Query
                  - dynamodb:DeleteItem
                Resource: !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DynamoTableName}'
              - Sid: EventBridgeDeleteRules
                Effect: Allow
                Action:
                  - events:RemoveTargets
                  - events:DeleteRule
                  - events:DescribeRule
                Resource: !Sub 'arn:aws:events:${AWS::Region}:${AWS::AccountId}:rule/*'
              - Sid: ECRAccess
                Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                  - ecr:BatchCheckLayerAvailability
                  - ecr:GetDownloadUrlForLayer
                  - ecr:BatchGetImage
                Resource: '*'
              - Sid: EC2NetworkInterface
                Effect: Allow
                Action:
                  - ec2:CreateNetworkInterface
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DeleteNetworkInterface
                Resource: '*'
      Tags:
        - Key: Project
          Value: gits
  StatusLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-status-lambda-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: StatusLambdaAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: DynamoQuery
                Effect: Allow
                Action:
                  - dynamodb:Query
                Resource: !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DynamoTableName}'
              - Sid: ECRAccess
                Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                  - ecr:BatchCheckLayerAvailability
                  - ecr:GetDownloadUrlForLayer
                  - ecr:BatchGetImage
                Resource: '*'
              - Sid: EC2NetworkInterface
                Effect: Allow
                Action:
                  - ec2:CreateNetworkInterface
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DeleteNetworkInterface
                Resource: '*'
      Tags:
        - Key: Project
          Value: gits
  CodeBuildLensLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-codebuildlens-lambda-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: CodeBuildLensLambdaAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: CodeBuildRead
                Effect: Allow
                Action:
                  - codebuild:BatchGetBuilds
                  - codebuild:ListProjects
                Resource: '*'
              - Sid: DynamoQuery
                Effect: Allow
                Action:
                  - dynamodb:Query
                Resource: !Sub 'arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/${DynamoTableName}'
              - Sid: ECRAccess
                Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                  - ecr:BatchCheckLayerAvailability
                  - ecr:GetDownloadUrlForLayer
                  - ecr:BatchGetImage
                Resource: '*'
              - Sid: EC2NetworkInterface
                Effect: Allow
                Action:
                  - ec2:CreateNetworkInterface
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DeleteNetworkInterface
                Resource: '*'
      Tags:
        - Key: Project
          Value: gits
  EventBridgeTargetRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-events-target'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: events.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: AllowStartCodeBuild
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - codebuild:StartBuild
                Resource: !Sub 'arn:aws:codebuild:${AWS::Region}:${AWS::AccountId}:project/${ProjectName}'
      Tags:
        - Key: Project
          Value: gits
  CodeBuildServiceRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-codebuild-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: codebuild.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: CodeBuildSecretsS3Logs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Sid: CodeBuild
                Effect: Allow
                Action:
                  - codebuild:*
                Resource: '*'
              - Sid: S3ReadArtifacts
                Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:GetObjectVersion
                Resource: !Sub 'arn:aws:s3:::${ArtifactBucketName}/*'
              - Sid: SecretsManagerRead
                Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                  - secretsmanager:DescribeSecret
                  - secretsmanager:CreateSecret
                Resource: !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:*'
              - Sid: CloudWatchLogs
                Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'
              - Sid: EC2Describe
                Effect: Allow
                Action:
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeSubnets
                  - ec2:DescribeVpcs
                Resource: '*'
      Tags:
        - Key: Project
          Value: gits
  CloudFormationDeploymentPolicy:
    Type: AWS::IAM::ManagedPolicy
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - dynamodb:CreateTable
              - dynamodb:DescribeTable
              - dynamodb:UpdateTable
              - dynamodb:DeleteTable
              - dynamodb:UpdateContinuousBackups
              - dynamodb:DescribeContinuousBackups
              - dynamodb:TagResource
              - dynamodb:UntagResource
              - dynamodb:ListTagsOfResource
              - s3:CreateBucket
              - s3:PutBucketVersioning
              - s3:PutBucketEncryption
              - s3:PutEncryptionConfiguration
              - s3:PutPublicAccessBlock
              - s3:PutBucketPublicAccessBlock
              - s3:DeleteBucket
              - s3:GetBucketPolicy
              - s3:PutBucketPolicy
              - s3:DeleteBucketPolicy
              - s3:GetBucketVersioning
              - s3:GetEncryptionConfiguration
              - s3:GetBucketPublicAccessBlock
              - s3:ListBucket
              - s3:PutBucketTagging
              - s3:GetBucketTagging
              - iam:CreateRole
              - iam:GetRole
              - iam:UpdateRole
              - iam:AttachRolePolicy
              - iam:PutRolePolicy
              - iam:GetRolePolicy
              - iam:DeleteRolePolicy
              - iam:CreatePolicy
              - iam:GetPolicy
              - iam:DeleteRole
              - iam:DetachRolePolicy
              - iam:DeletePolicy
              - iam:PassRole
              - iam:TagRole
              - iam:UntagRole
              - iam:ListRolePolicies
              - iam:ListAttachedRolePolicies
              - ecr:CreateRepository
              - ecr:DescribeRepositories
              - ecr:DeleteRepository
              - ecr:GetRepositoryPolicy
              - ecr:SetRepositoryPolicy
              - ecr:PutImageScanningConfiguration
              - ecr:PutLifecyclePolicy
              - ecr:GetLifecyclePolicy
              - ecr:DeleteLifecyclePolicy
              - ecr:TagResource
              - ecr:ListTagsForResource
              - ecr:GetAuthorizationToken
              - ecr:BatchCheckLayerAvailability
              - ecr:GetDownloadUrlForLayer
              - ecr:BatchGetImage
              - ecr:InitiateLayerUpload
              - ecr:UploadLayerPart
              - ecr:CompleteLayerUpload
              - ecr:PutImage
              - ecr:DescribeImages
              - secretsmanager:CreateSecret
              - secretsmanager:DescribeSecret
              - secretsmanager:UpdateSecret
              - secretsmanager:DeleteSecret
              - secretsmanager:GetSecretValue
              - secretsmanager:TagResource
              - codebuild:CreateProject
              - codebuild:UpdateProject
              - codebuild:DeleteProject
              - codebuild:BatchGetProjects
              - codebuild:ImportSourceCredentials
              - codebuild:DeleteSourceCredentials
              - lambda:CreateFunction
              - lambda:GetFunction
              - lambda:UpdateFunctionCode
              - lambda:UpdateFunctionConfiguration
              - lambda:DeleteFunction
              - lambda:AddPermission
              - lambda:RemovePermission
              - lambda:GetPolicy
              - lambda:TagResource
              - lambda:ListTags
              - events:PutRule
              - events:PutTargets
              - events:DeleteRule
              - events:RemoveTargets
              - events:DescribeRule
              - events:ListTargetsByRule
              - events:TagResource
              - apigateway:*
              - cloudformation:CreateStack
              - cloudformation:UpdateStack
              - cloudformation:DeleteStack
              - cloudformation:DescribeStacks
              - cloudformation:DescribeStackEvents
              - cloudformation:DescribeStackResources
              - cloudformation:GetTemplate
              - cloudformation:GetTemplateSummary
              - cloudformation:ValidateTemplate
              - cloudformation:CreateChangeSet
              - cloudformation:DescribeChangeSet
              - cloudformation:ExecuteChangeSet
              - cloudformation:DeleteChangeSet
              - cloudformation:ListChangeSets
              - cloudformation:ListStackResources
              - cloudformation:GetStackPolicy
              - logs:CreateLogGroup
              - logs:DeleteLogGroup
              - logs:DescribeLogGroups
              - logs:PutRetentionPolicy
              - logs:TagLogGroup
            Resource: '*'
          - Effect: Allow
            Action:
              - ec2:DescribeAvailabilityZones
              - ec2:DescribeRegions
              - ec2:CreateVpc
              - ec2:DescribeVpcs
              - ec2:DeleteVpc
              - ec2:ModifyVpcAttribute
              - ec2:CreateInternetGateway
              - ec2:DescribeInternetGateways
              - ec2:DeleteInternetGateway
              - ec2:AttachInternetGateway
              - ec2:DetachInternetGateway
              - ec2:CreateSubnet
              - ec2:DescribeSubnets
              - ec2:DeleteSubnet
              - ec2:CreateNatGateway
              - ec2:DescribeNatGateways
              - ec2:DeleteNatGateway
              - ec2:CreateRouteTable
              - ec2:DescribeRouteTables
              - ec2:DeleteRouteTable
              - ec2:CreateRoute
              - ec2:DeleteRoute
              - ec2:AssociateRouteTable
              - ec2:DisassociateRouteTable
              - ec2:CreateSecurityGroup
              - ec2:DescribeSecurityGroups
              - ec2:DeleteSecurityGroup
              - ec2:AuthorizeSecurityGroupEgress
              - ec2:RevokeSecurityGroupEgress
              - ec2:CreateVpcEndpoint
              - ec2:DescribeVpcEndpoints
              - ec2:DeleteVpcEndpoint
              - ec2:CreateTags
              - ec2:DescribeTags
              - ec2:DeleteTags
              - ec2:AllocateAddress
              - ec2:DescribeAddresses
              - ec2:ReleaseAddress
            Resource: '*'
      Description: Policy for CloudFormation deployment permissions
  CloudFormationDeploymentRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub '${ProjectName}-cloudformation-deployment-role'
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              AWS:
                - !Sub 'arn:aws:iam::${AWS::AccountId}:root'
                - !Sub 'arn:aws:iam::${AWS::AccountId}:user/mahmood'
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - !Ref CloudFormationDeploymentPolicy
      Tags:
        - Key: Project
          Value: gits

Outputs:
  ScheduleLambdaRoleArn:
    Description: ARN of role assumed by Schedule Lambda function.
    Value: !GetAtt ScheduleLambdaRole.Arn
    Export:
      Name: !Sub '${ProjectName}-ScheduleLambdaRoleArn'
  DeleteLambdaRoleArn:
    Description: ARN of role assumed by Delete Lambda function.
    Value: !GetAtt DeleteLambdaRole.Arn
    Export:
      Name: !Sub '${ProjectName}-DeleteLambdaRoleArn'
  StatusLambdaRoleArn:
    Description: ARN of role assumed by GetStatus Lambda function.
    Value: !GetAtt StatusLambdaRole.Arn
    Export:
      Name: !Sub '${ProjectName}-StatusLambdaRoleArn'
  CodeBuildLensLambdaRoleArn:
    Description: ARN of role assumed by CodeBuildLens Lambda function.
    Value: !GetAtt CodeBuildLensLambdaRole.Arn
    Export:
      Name: !Sub '${ProjectName}-CodeBuildLensLambdaRoleArn'
  EventBridgeTargetRoleArn:
    Description: ARN of role used by EventBridge to invoke CodeBuild.
    Value: !GetAtt EventBridgeTargetRole.Arn
    Export:
      Name: !Sub '${ProjectName}-EventBridgeTargetRoleArn'
  CodeBuildServiceRoleArn:
    Description: ARN of CodeBuild project service role.
    Value: !GetAtt CodeBuildServiceRole.Arn
    Export:
      Name: !Sub '${ProjectName}-CodeBuildServiceRoleArn'
  CloudFormationDeploymentRoleArn:
    Description: ARN of the CloudFormation deployment role.
    Value: !GetAtt CloudFormationDeploymentRole.Arn
    Export:
      Name: !Sub '${ProjectName}-CloudFormationDeploymentRoleArn'
